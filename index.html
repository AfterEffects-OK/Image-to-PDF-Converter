<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>瞬速！画像PDFメーカー</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #bbdefb 100%); /* Subtle blue gradient background */
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        /* Custom scrollbar for image preview area */
        #image-preview-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        #image-preview-container::-webkit-scrollbar-track {
            background: #e0e0e0;
            border-radius: 10px;
        }
        #image-preview-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        #image-preview-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Buttons only show on hover */
        .group:hover .opacity-0 {
            opacity: 1;
        }
        .group .opacity-0 {
            opacity: 0;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-2xl border border-gray-100 transform transition-transform duration-300 hover:scale-[1.005]">
        <h1 class="text-4xl font-extrabold text-center text-gray-800 mb-8 tracking-tight">瞬速！画像PDFメーカー</h1>

        <!-- File Upload Section -->
        <div class="mb-8">
            <label for="file-input" class="block text-lg font-semibold text-gray-700 mb-3">
                画像をアップロード (複数選択可)
            </label>
            <div id="drop-area" class="flex flex-col items-center justify-center w-full h-52 border-4 border-dashed border-blue-400 rounded-xl cursor-pointer bg-blue-50 hover:bg-blue-100 transition-all duration-300 transform hover:scale-[1.01] shadow-inner text-blue-600">
                <input type="file" id="file-input" multiple accept="image/*" class="hidden">
                <svg class="w-16 h-16 text-blue-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 0115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <p class="mt-2 text-base font-medium">ファイルをドラッグ＆ドロップするか、クリックして選択</p>
                <p class="text-sm text-gray-500">(PNG, JPG, JPEGなどの画像ファイル)</p>
            </div>
        </div>

        <!-- Image Preview Section -->
        <div id="image-preview-container" class="mb-8 p-5 border border-gray-300 rounded-xl bg-gray-50 overflow-y-auto max-h-72 shadow-inner">
            <div id="image-preview-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-5">
                <!-- Image previews will be inserted here by JavaScript -->
            </div>
            <p id="no-images-message" class="text-center text-gray-500 text-base mt-4">画像が選択されていません。</p>
        </div>

        <!-- PDF Options Section -->
        <div class="mb-8">
            <label for="pdf-filename" class="block text-lg font-semibold text-gray-700 mb-3">
                PDFファイル名
            </label>
            <input type="text" id="pdf-filename" class="mt-1 block w-full px-5 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-base placeholder-gray-400" placeholder="例: MyDocument">
        </div>

        <div class="mb-8">
            <label class="block text-lg font-semibold text-gray-700 mb-3">
                変換オプション
            </label>
            <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-6">
                <label class="inline-flex items-center cursor-pointer">
                    <input type="radio" name="conversion-option" value="single" checked class="form-radio h-5 w-5 text-blue-600 border-gray-300 focus:ring-blue-500 transition-colors duration-200">
                    <span class="ml-3 text-gray-700 text-base">複数画像を1つのPDFにまとめる</span>
                </label>
                <label class="inline-flex items-center cursor-pointer">
                    <input type="radio" name="conversion-option" value="multiple" class="form-radio h-5 w-5 text-blue-600 border-gray-300 focus:ring-blue-500 transition-colors duration-200">
                    <span class="ml-3 text-gray-700 text-base">複数画像を連番のPDFファイルにする</span>
                </label>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row justify-center space-y-5 sm:space-y-0 sm:space-x-6">
            <button id="convert-button" class="w-full sm:w-auto px-8 py-4 bg-gradient-to-r from-blue-600 to-blue-700 text-white font-bold rounded-xl shadow-lg hover:from-blue-700 hover:to-blue-800 focus:outline-none focus:ring-4 focus:ring-blue-300 focus:ring-offset-2 transition-all duration-300 flex items-center justify-center text-lg transform hover:-translate-y-1">
                <span id="convert-button-text">PDFに変換してダウンロード</span>
                <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-6 w-6 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </button>
            <button id="clear-button" class="w-full sm:w-auto px-8 py-4 bg-gradient-to-r from-red-500 to-red-600 text-white font-bold rounded-xl shadow-lg hover:from-red-600 hover:to-red-700 focus:outline-none focus:ring-4 focus:ring-red-300 focus:ring-offset-2 transition-all duration-300 text-lg transform hover:-translate-y-1">
                全てクリア
            </button>
        </div>

        <!-- Message Box for alerts -->
        <div id="message-box" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 hidden backdrop-blur-sm">
            <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full text-center border border-gray-200 transform scale-95 opacity-0 transition-all duration-300" id="message-box-content">
                <p id="message-text" class="text-xl font-semibold text-gray-800 mb-6"></p>
                <button id="close-message-box" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors duration-200">閉じる</button>
            </div>
        </div>
    </div>

    <!-- jsPDF CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- JSZip CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        // Initialize jsPDF
        const { jsPDF } = window.jspdf;
        // JSZip is available as window.JSZip
        const JSZip = window.JSZip;

        // Get DOM elements
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreviewGrid = document.getElementById('image-preview-grid');
        const noImagesMessage = document.getElementById('no-images-message');
        const pdfFilenameInput = document.getElementById('pdf-filename');
        const convertButton = document.getElementById('convert-button');
        const convertButtonText = document.getElementById('convert-button-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const clearButton = document.getElementById('clear-button');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const closeMessageBox = document.getElementById('close-message-box');
        const messageBoxContent = document.getElementById('message-box-content');

        // Array to store image data objects: { file: File, id: string, timestamp: number }
        let imageFiles = [];

        // --- Utility Functions ---

        /**
         * Displays a custom message box instead of alert().
         * @param {string} message The message to display.
         */
        function showMessageBox(message) {
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
            // Animate message box in
            setTimeout(() => {
                messageBoxContent.classList.remove('opacity-0', 'scale-95');
                messageBoxContent.classList.add('opacity-100', 'scale-100');
            }, 10);
        }

        /**
         * Hides the custom message box.
         */
        function hideMessageBox() {
            // Animate message box out
            messageBoxContent.classList.remove('opacity-100', 'scale-100');
            messageBoxContent.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 300); // Match CSS transition duration
        }

        /**
         * Shows the loading spinner and disables the convert button.
         * @param {string} [initialText] Optional text to display on the button.
         */
        function showLoading(initialText = '変換中...') {
            loadingSpinner.classList.remove('hidden');
            convertButtonText.textContent = initialText;
            convertButton.disabled = true;
            clearButton.disabled = true;
            fileInput.disabled = true;
            pdfFilenameInput.disabled = true;
            document.querySelectorAll('input[name="conversion-option"]').forEach(radio => radio.disabled = true);
        }

        /**
         * Hides the loading spinner and enables the convert button.
         */
        function hideLoading() {
            loadingSpinner.classList.add('hidden');
            convertButtonText.textContent = 'PDFに変換してダウンロード';
            convertButton.disabled = false;
            clearButton.disabled = false;
            fileInput.disabled = false;
            pdfFilenameInput.disabled = false;
            document.querySelectorAll('input[name="conversion-option"]').forEach(radio => radio.disabled = false);
        }

        /**
         * Renders the image previews in the grid, sorted by timestamp.
         */
        function renderImagePreviews() {
            imagePreviewGrid.innerHTML = ''; // Clear existing previews

            // Sort imageFiles by timestamp before rendering
            imageFiles.sort((a, b) => a.timestamp - b.timestamp);

            if (imageFiles.length === 0) {
                noImagesMessage.classList.remove('hidden');
                imagePreviewContainer.classList.add('hidden'); // Hide container if no images
                return;
            } else {
                noImagesMessage.classList.add('hidden');
                imagePreviewContainer.classList.remove('hidden'); // Show container if images exist
            }

            imageFiles.forEach((imageData) => {
                const file = imageData.file;
                const id = imageData.id;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const imgContainer = document.createElement('div');
                    imgContainer.classList.add('relative', 'group', 'rounded-lg', 'overflow-hidden', 'shadow-md', 'border', 'border-gray-200');
                    imgContainer.setAttribute('data-id', id); // Use id for consistent referencing

                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.alt = file.name;
                    img.classList.add('w-full', 'h-28', 'object-cover', 'rounded-lg', 'transition-transform', 'duration-200', 'group-hover:scale-105');

                    const fileNameOverlay = document.createElement('div');
                    fileNameOverlay.classList.add('absolute', 'bottom-0', 'left-0', 'right-0', 'bg-black', 'bg-opacity-60', 'text-white', 'text-xs', 'p-2', 'truncate', 'opacity-0', 'group-hover:opacity-100', 'transition-opacity', 'duration-200', 'font-medium');
                    fileNameOverlay.textContent = file.name;

                    // Remove button
                    const removeButton = document.createElement('button');
                    removeButton.classList.add('absolute', 'top-2', 'right-2', 'bg-red-600', 'text-white', 'rounded-full', 'w-7', 'h-7', 'flex', 'items-center', 'justify-center', 'text-sm', 'opacity-0', 'group-hover:opacity-100', 'transition-opacity', 'duration-200', 'hover:bg-red-700', 'shadow-md');
                    removeButton.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>'; // 'x' icon
                    removeButton.onclick = (event) => {
                        event.stopPropagation(); // Prevent event bubbling
                        removeImage(id); // Pass id to removeImage
                    };

                    imgContainer.appendChild(img);
                    imgContainer.appendChild(fileNameOverlay);
                    imgContainer.appendChild(removeButton);
                    imagePreviewGrid.appendChild(imgContainer);
                };
                reader.readAsDataURL(file);
            });
        }

        /**
         * Removes an image from the imageFiles array by its unique ID and re-renders previews.
         * @param {string} idToRemove The unique ID of the image to remove.
         */
        function removeImage(idToRemove) {
            console.log(`Removing image with ID: ${idToRemove}`);
            imageFiles = imageFiles.filter(imgData => imgData.id !== idToRemove);
            renderImagePreviews(); // Re-render to update display
            console.log('Image files after removal:', imageFiles.map(f => f.file.name));
        }

        /**
         * Triggers a download for a given Blob.
         * @param {Blob} blob The Blob to download.
         * @param {string} filename The name of the file to save.
         */
        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- Event Listeners ---

        // Handle file input change
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            const newImageDatas = files.map(file => ({
                file: file,
                id: crypto.randomUUID(), // Generate unique ID
                timestamp: Date.now()    // Record timestamp
            }));
            imageFiles = [...imageFiles, ...newImageDatas]; // Add new files to existing ones
            console.log('Files added via input:', newImageDatas.map(d => d.file.name));
            renderImagePreviews();
        });

        // Handle drag and drop for file upload
        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.classList.add('border-blue-600', 'bg-blue-100');
        });

        dropArea.addEventListener('dragleave', () => {
            dropArea.classList.remove('border-blue-600', 'bg-blue-100');
        });

        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.classList.remove('border-blue-600', 'bg-blue-100');
            const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
            if (files.length > 0) {
                const newImageDatas = files.map(file => ({
                    file: file,
                    id: crypto.randomUUID(), // Generate unique ID
                    timestamp: Date.now()    // Record timestamp
                }));
                imageFiles = [...imageFiles, ...newImageDatas];
                console.log('Files added via drag/drop:', newImageDatas.map(d => d.file.name));
                renderImagePreviews();
            } else {
                showMessageBox('画像ファイルのみをドラッグ＆ドロップしてください。');
            }
        });

        // Trigger file input click when drop area is clicked
        dropArea.addEventListener('click', () => {
            fileInput.click();
        });

        // Handle conversion button click
        convertButton.addEventListener('click', async () => {
            if (imageFiles.length === 0) {
                showMessageBox('PDFに変換する画像を選択してください。');
                return;
            }

            const filename = pdfFilenameInput.value.trim() || 'document'; // Default filename
            const conversionOption = document.querySelector('input[name="conversion-option"]:checked').value;

            try {
                if (conversionOption === 'single') {
                    showLoading(); // Show general loading for single PDF
                    // Combine multiple images into a single PDF
                    const doc = new jsPDF({
                        orientation: 'portrait', // Default to portrait
                        unit: 'px',
                        format: 'a4' // Default to A4 size
                    });

                    for (const imageData of imageFiles) { // Iterate over image data objects
                        const file = imageData.file;
                        const reader = new FileReader();
                        reader.readAsDataURL(file);
                        await new Promise((resolve) => {
                            reader.onload = (e) => {
                                const img = new Image();
                                img.src = e.target.result;
                                img.onload = () => {
                                    const imgWidth = img.width;
                                    const imgHeight = img.height;

                                    // Calculate dimensions to fit A4 page
                                    const a4Width = doc.internal.pageSize.getWidth();
                                    const a4Height = doc.internal.pageSize.getHeight();

                                    let ratio = Math.min(a4Width / imgWidth, a4Height / imgHeight);
                                    let scaledWidth = imgWidth * ratio;
                                    let scaledHeight = imgHeight * ratio;

                                    // Center the image on the page
                                    let xOffset = (a4Width - scaledWidth) / 2;
                                    let yOffset = (a4Height - scaledHeight) / 2;

                                    // Add a new page for each image, except for the first image
                                    // Use imageData.id to find the correct index in the sorted array
                                    const currentIndex = imageFiles.findIndex(item => item.id === imageData.id);
                                    if (currentIndex > 0) {
                                        doc.addPage();
                                    }
                                    doc.addImage(img.src, 'JPEG', xOffset, yOffset, scaledWidth, scaledHeight);
                                    resolve();
                                };
                                img.onerror = () => {
                                    console.error('Failed to load image:', file.name);
                                    showMessageBox(`画像の読み込みに失敗しました: ${file.name}`);
                                    resolve(); // Resolve even on error to continue processing other images
                                };
                            };
                        });
                    }
                    doc.save(`${filename}.pdf`);
                    showMessageBox('PDFが正常に生成され、ダウンロードされました！');

                } else {
                    // Create separate PDFs for each image and then zip them
                    showLoading(`1/${imageFiles.length} 画像を変換中...`); // Initial progress text
                    const zip = new JSZip();

                    for (let i = 0; i < imageFiles.length; i++) {
                        const imageData = imageFiles[i]; // Get imageData object
                        const file = imageData.file;

                        // Update progress text for each file
                        convertButtonText.textContent = `${i + 1}/${imageFiles.length} 画像を変換中...`;

                        const doc = new jsPDF({
                            orientation: 'portrait',
                            unit: 'px',
                            format: 'a4'
                        });

                        const reader = new FileReader();
                        reader.readAsDataURL(file);
                        await new Promise((resolve) => {
                            reader.onload = (e) => {
                                const img = new Image();
                                img.src = e.target.result;
                                img.onload = () => {
                                    const imgWidth = img.width;
                                    const imgHeight = img.height;

                                    const a4Width = doc.internal.pageSize.getWidth();
                                    const a4Height = doc.internal.pageSize.getHeight();

                                    let ratio = Math.min(a4Width / imgWidth, a4Height / imgHeight);
                                    let scaledWidth = imgWidth * ratio;
                                    let scaledHeight = imgHeight * ratio;

                                    let xOffset = (a4Width - scaledWidth) / 2;
                                    let yOffset = (a4Height - scaledHeight) / 2;

                                    doc.addImage(img.src, 'JPEG', xOffset, yOffset, scaledWidth, scaledHeight);
                                    const pdfBlob = doc.output('blob'); // Get PDF as Blob
                                    zip.file(`${filename}_${i + 1}.pdf`, pdfBlob); // Add to zip
                                    resolve();
                                };
                                img.onerror = () => {
                                    console.error('Failed to load image:', file.name);
                                    showMessageBox(`画像の読み込みに失敗しました: ${file.name}`);
                                    resolve();
                                };
                            };
                        });
                    }

                    // Generate and download the ZIP file
                    convertButtonText.textContent = 'ZIPファイルを生成中...';
                    const zipBlob = await zip.generateAsync({ type: "blob" });
                    downloadBlob(zipBlob, `${filename}.zip`); // Use the new download function
                    showMessageBox('PDFファイルがZIPとして正常に生成され、ダウンロードされました！');
                }
            } catch (error) {
                console.error('PDF変換エラー:', error);
                showMessageBox('PDF変換中にエラーが発生しました。');
            } finally {
                hideLoading();
            }
        });

        // Handle clear button click
        clearButton.addEventListener('click', () => {
            imageFiles = []; // Clear the array
            fileInput.value = ''; // Reset file input
            renderImagePreviews(); // Clear previews
            pdfFilenameInput.value = ''; // Clear filename
            document.querySelector('input[name="conversion-option"][value="single"]').checked = true; // Reset option
            showMessageBox('全てのデータがクリアされました。');
        });

        // Close message box
        closeMessageBox.addEventListener('click', hideMessageBox);

        // Initial render (to show "No images selected" message)
        renderImagePreviews();
    </script>
</body>
</html>
